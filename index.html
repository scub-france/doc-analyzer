<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocTags Interface</title>
    <style>
        :root {
            --primary-color: #2962ff;
            --primary-light: #768fff;
            --primary-dark: #0039cb;
            --text-color: #333;
            --light-gray: #f5f5f5;
            --border-color: #ddd;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #f44336;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            color: var(--text-color);
            line-height: 1.6;
            background-color: #f9f9f9;
            padding: 20px;
        }

        header {
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        h1 {
            color: var(--primary-dark);
            font-size: 24px;
            margin-bottom: 10px;
        }

        h2 {
            font-size: 20px;
            margin: 20px 0 10px;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            width: 100%;
        }

        .upload-section {
            flex: 1;
            min-width: 300px;
        }

        .processing-section {
            flex: 1;
            min-width: 300px;
        }

        .results-section {
            flex: 2;
            min-width: 500px;
        }

        .file-input-wrapper {
            position: relative;
            margin-bottom: 20px;
        }

        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: block;
            background-color: var(--light-gray);
            border: 2px dashed var(--border-color);
            border-radius: 5px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input-label:hover, .file-input:focus + .file-input-label {
            background-color: #e8e8e8;
            border-color: var(--primary-light);
        }

        .file-info {
            margin-top: 15px;
            display: none;
        }

        .file-name {
            font-weight: bold;
        }

        .page-selector {
            margin: 15px 0;
        }

        .parameter-inputs {
            margin: 15px 0;
        }

        .parameter-group {
            margin-bottom: 10px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--primary-dark);
        }

        button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }

        .job-progress {
            margin: 20px 0;
            display: none;
        }

        .progress-bar-container {
            height: 20px;
            background-color: var(--light-gray);
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.5s;
        }

        .job-status {
            font-weight: 500;
        }

        .status-running {
            color: var(--primary-color);
        }

        .status-completed {
            color: var(--success-color);
        }

        .status-error {
            color: var(--error-color);
        }

        .pdf-preview {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .thumbnails {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .thumbnail {
            width: 120px;
            height: 160px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            object-fit: cover;
            transition: all 0.2s;
        }

        .thumbnail:hover, .thumbnail.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(41, 98, 255, 0.5);
        }

        .result-container {
            margin-top: 20px;
            display: none;
        }

        .result-iframe {
            width: 100%;
            height: 500px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }

        .error-message {
            color: var(--error-color);
            margin: 10px 0;
            display: none;
        }

        .api-debug {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 15px;
            overflow: auto;
            max-height: 200px;
        }

        .api-debug pre {
            margin: 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }

        .troubleshooting h3 {
            margin-top: 0;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .api-url-settings {
            margin-top: 15px;
            padding: 10px;
            background-color: #f0f9ff;
            border: 1px solid #d0e5f5;
            border-radius: 5px;
        }

        .api-url-input {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<header>
    <h1>DocTags - PDF Document Processing</h1>
    <p>Upload your PDF files and process them with DocTags to extract structured content</p>
</header>

<div class="container">
    <div class="upload-section card">
        <h2>Upload PDF</h2>
        <div class="api-url-settings">
            <label for="api-url">API URL:</label>
            <input type="text" id="api-url" class="api-url-input" value="http://localhost:5000/api">
            <button id="update-url-btn" style="margin-top: 5px;">Update URL</button>
        </div>

        <div class="file-input-wrapper" style="margin-top: 15px;">
            <input type="file" id="pdf-upload" class="file-input" accept=".pdf">
            <label for="pdf-upload" class="file-input-label">
                <i class="fas fa-cloud-upload-alt"></i>
                <div>Drag & drop your PDF here or click to browse</div>
            </label>
        </div>

        <div class="file-info" id="file-info">
            <p>Selected file: <span class="file-name" id="file-name"></span></p>
            <p>Pages: <span id="page-count">0</span></p>
            <p id="file-size-info">Size: <span id="file-size">0</span> KB</p>
        </div>

        <div class="error-message" id="upload-error"></div>

        <div class="api-debug" style="margin-top: 20px; font-size: 12px; color: #666; display: none;" id="api-debug">
            <h3>API Debug Info</h3>
            <pre id="api-debug-content"></pre>
        </div>
    </div>

    <div class="processing-section card">
        <h2>Process Document</h2>

        <div class="page-selector">
            <label for="page-select">Select Pages:</label>
            <select id="page-select" disabled>
                <option value="all">All Pages</option>
                <option value="custom">Custom Range</option>
            </select>
            <div id="custom-range" style="margin-top: 10px; display: none;">
                <label for="start-page">From page:</label>
                <input type="number" id="start-page" min="1" value="1">
                <label for="end-page">To page:</label>
                <input type="number" id="end-page" min="1" value="1">
            </div>
        </div>

        <div class="parameter-inputs">
            <h3>Scaling Parameters</h3>
            <div class="parameter-group">
                <label for="x-factor">X-Axis Scaling Factor:</label>
                <input type="number" id="x-factor" step="0.1" min="0.1" max="2.0" value="0.7">
            </div>
            <div class="parameter-group">
                <label for="y-factor">Y-Axis Scaling Factor:</label>
                <input type="number" id="y-factor" step="0.1" min="0.1" max="2.0" value="0.7">
            </div>
            <div class="parameter-group">
                <label for="dpi">DPI for PDF rendering:</label>
                <input type="number" id="dpi" step="50" min="72" max="600" value="200">
            </div>
        </div>

        <button id="process-btn" disabled>Process Document</button>

        <div class="troubleshooting" style="margin-top: 15px; padding: 10px; background-color: #f9f9f9; border-radius: 5px; display: none;" id="troubleshooting">
            <h3>Troubleshooting</h3>
            <button id="check-pdf-btn" style="margin: 5px 0; background-color: #ff9800;">Run PDF Health Check</button>
            <button id="test-connection-btn" style="margin: 5px 0; background-color: #2196F3;">Test API Connection</button>
        </div>

        <div class="job-progress" id="job-progress">
            <h3>Processing Status</h3>
            <p>Status: <span class="job-status" id="job-status">Waiting...</span></p>
            <p>Progress: <span id="progress-percent">0</span>%</p>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <p>Current page: <span id="current-page">-</span></p>
            <p>Current step: <span id="current-step">-</span></p>
        </div>

        <div class="error-message" id="process-error"></div>
    </div>

    <div class="results-section card">
        <h2>Results</h2>
        <div id="no-results" style="text-align: center; padding: 40px 0;">
            <p>No results to display yet. Upload and process a document to see results here.</p>
        </div>

        <div class="result-container" id="result-container">
            <iframe id="result-iframe" class="result-iframe" src="about:blank"></iframe>
        </div>
    </div>
</div>

<script>
    // Default API URL
    let API_BASE_URL = "http://localhost:5000/api";

    // Try to load from localStorage if available
    if (window.localStorage && localStorage.getItem('doctags_api_url')) {
        API_BASE_URL = localStorage.getItem('doctags_api_url');
    }

    // Current job state
    let currentJobId = null;
    let currentFileInfo = null;
    let statusCheckInterval = null;

    // DOM elements
    const apiUrlInput = document.getElementById('api-url');
    const updateUrlBtn = document.getElementById('update-url-btn');
    const fileUpload = document.getElementById('pdf-upload');
    const fileInfo = document.getElementById('file-info');
    const fileName = document.getElementById('file-name');
    const pageCount = document.getElementById('page-count');
    const fileSize = document.getElementById('file-size');
    const uploadError = document.getElementById('upload-error');
    const apiDebug = document.getElementById('api-debug');
    const apiDebugContent = document.getElementById('api-debug-content');

    const pageSelect = document.getElementById('page-select');
    const customRange = document.getElementById('custom-range');
    const startPage = document.getElementById('start-page');
    const endPage = document.getElementById('end-page');

    const xFactor = document.getElementById('x-factor');
    const yFactor = document.getElementById('y-factor');
    const dpi = document.getElementById('dpi');

    const processBtn = document.getElementById('process-btn');
    const jobProgress = document.getElementById('job-progress');
    const jobStatus = document.getElementById('job-status');
    const progressPercent = document.getElementById('progress-percent');
    const progressBar = document.getElementById('progress-bar');
    const currentPage = document.getElementById('current-page');
    const currentStep = document.getElementById('current-step');
    const processError = document.getElementById('process-error');

    const troubleshooting = document.getElementById('troubleshooting');
    const checkPdfBtn = document.getElementById('check-pdf-btn');
    const testConnectionBtn = document.getElementById('test-connection-btn');

    const noResults = document.getElementById('no-results');
    const resultContainer = document.getElementById('result-container');
    const resultIframe = document.getElementById('result-iframe');

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize API URL input
        apiUrlInput.value = API_BASE_URL;

        console.log('Using API URL:', API_BASE_URL);

        // Load default parameters from API
        fetchDefaultParams();

        // Set up event listeners
        updateUrlBtn.addEventListener('click', updateApiUrl);
        fileUpload.addEventListener('change', handleFileUpload);
        pageSelect.addEventListener('change', handlePageSelectChange);
        processBtn.addEventListener('click', processDocument);
        checkPdfBtn.addEventListener('click', checkPdfHealth);
        testConnectionBtn.addEventListener('click', testApiConnection);

        // Check API health on load
        checkApiHealth();
    });

    // Update API URL
    function updateApiUrl() {
        const newUrl = apiUrlInput.value.trim();
        if (!newUrl) {
            uploadError.textContent = 'Please enter a valid API URL';
            uploadError.style.display = 'block';
            return;
        }

        // Remove trailing slash if present
        API_BASE_URL = newUrl.endsWith('/') ? newUrl.slice(0, -1) : newUrl;

        // Save to localStorage if available
        if (window.localStorage) {
            localStorage.setItem('doctags_api_url', API_BASE_URL);
        }

        console.log('API URL updated to:', API_BASE_URL);
        uploadError.textContent = 'API URL updated successfully. Testing connection...';
        uploadError.style.color = 'green';
        uploadError.style.display = 'block';

        // Test the connection with the new URL
        testApiConnection();
    }

    // Check API health
    async function checkApiHealth() {
        try {
            console.log('Checking API health at:', `${API_BASE_URL}/health`);
            const response = await fetch(`${API_BASE_URL}/health`);
            if (response.ok) {
                console.log('API is healthy');
            } else {
                console.error('API health check failed with status:', response.status);
                uploadError.textContent = 'Warning: The DocTags API appears to be unavailable. Please check that the API server is running.';
                uploadError.style.display = 'block';
                troubleshooting.style.display = 'block';
            }
        } catch (error) {
            console.error('API health check error:', error);
            uploadError.textContent = 'Error: Cannot connect to the DocTags API. Please check that the API server is running at ' + API_BASE_URL;
            uploadError.style.display = 'block';
            troubleshooting.style.display = 'block';
        }
    }

    // Test API connection
    async function testApiConnection() {
        try {
            testConnectionBtn.textContent = 'Testing...';
            testConnectionBtn.disabled = true;

            const response = await fetch(`${API_BASE_URL}/health`);
            const data = await response.json();

            if (response.ok && data.status === 'ok') {
                uploadError.textContent = 'API connection successful!';
                uploadError.style.color = 'green';
            } else {
                uploadError.textContent = 'API connection failed. Status: ' + response.status;
                uploadError.style.color = 'red';
            }

            uploadError.style.display = 'block';
            testConnectionBtn.textContent = 'Test API Connection';
            testConnectionBtn.disabled = false;
        } catch (error) {
            console.error('API connection test error:', error);
            uploadError.textContent = 'API connection error: ' + error.message;
            uploadError.style.color = 'red';
            uploadError.style.display = 'block';
            testConnectionBtn.textContent = 'Test API Connection';
            testConnectionBtn.disabled = false;
        }
    }

    // Check PDF health
    async function checkPdfHealth() {
        if (!currentFileInfo) {
            uploadError.textContent = 'Please upload a PDF first';
            uploadError.style.display = 'block';
            return;
        }

        try {
            checkPdfBtn.textContent = 'Checking...';
            checkPdfBtn.disabled = true;

            // Create a simple FormData with the current file
            const file = fileUpload.files[0];
            const formData = new FormData();
            formData.append('file', file);

            // Try a direct health check instead of a full upload
            const response = await fetch(`${API_BASE_URL}/upload`, {
                method: 'POST',
                body: formData
            });

            const responseText = await response.text();

            apiDebug.style.display = 'block';

            try {
                // Try to parse as JSON
                const data = JSON.parse(responseText);
                apiDebugContent.textContent = JSON.stringify(data, null, 2);

                if (response.ok) {
                    uploadError.textContent = `PDF health check passed! Page count: ${data.page_count}`;
                    uploadError.style.color = 'green';
                } else {
                    uploadError.textContent = `PDF health check failed: ${data.error || 'Unknown error'}`;
                    uploadError.style.color = 'red';
                }
            } catch (e) {
                // If not valid JSON, show the raw response
                apiDebugContent.textContent = responseText;
                uploadError.textContent = 'PDF health check failed with non-JSON response';
                uploadError.style.color = 'red';
            }

            uploadError.style.display = 'block';
            checkPdfBtn.textContent = 'Run PDF Health Check';
            checkPdfBtn.disabled = false;
        } catch (error) {
            console.error('PDF health check error:', error);
            uploadError.textContent = 'PDF health check error: ' + error.message;
            uploadError.style.color = 'red';
            uploadError.style.display = 'block';
            checkPdfBtn.textContent = 'Run PDF Health Check';
            checkPdfBtn.disabled = false;
        }
    }

    // Handle file upload
    async function handleFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        console.log('File selected:', file.name);

        // Check if file is a PDF
        if (!file.name.toLowerCase().endsWith('.pdf')) {
            uploadError.textContent = 'Error: Please upload a PDF file';
            uploadError.style.display = 'block';
            return;
        }

        // Reset UI
        resetUI();

        // Show file info
        fileName.textContent = file.name;
        const fileSizeKB = Math.round(file.size / 1024);
        fileSize.textContent = fileSizeKB;
        fileInfo.style.display = 'block';
        uploadError.style.display = 'none';
        apiDebug.style.display = 'none';

        // Upload file to API
        const formData = new FormData();
        formData.append('file', file);

        try {
            processBtn.disabled = true;
            processBtn.textContent = 'Uploading...';

            console.log('Uploading to:', `${API_BASE_URL}/upload`);

            // Improved error handling for fetch
            const response = await fetch(`${API_BASE_URL}/upload`, {
                method: 'POST',
                body: formData
            });

            console.log('Upload response status:', response.status);

            // Get response as text first
            const responseText = await response.text();
            console.log('Response text (first 100 chars):', responseText.substring(0, 100));

            let data;
            try {
                // Try to parse as JSON
                data = JSON.parse(responseText);
            } catch (jsonError) {
                console.error('Failed to parse response as JSON:', jsonError);
                throw new Error(`Server returned invalid JSON: ${responseText.substring(0, 100)}...`);
            }

            if (!response.ok) {
                throw new Error(data.error || `Upload failed with status ${response.status}`);
            }

            // Store job info
            currentJobId = data.job_id;
            currentFileInfo = {
                name: data.file_name,
                pageCount: data.page_count
            };

            // Update UI
            pageCount.textContent = data.page_count || 'Unknown';

            // Special handling for zero page count
            if (data.page_count && data.page_count > 0) {
                pageSelect.disabled = false;
                processBtn.disabled = false;

                // Set up page range inputs
                startPage.min = 1;
                startPage.max = data.page_count;
                startPage.value = 1;

                endPage.min = 1;
                endPage.max = data.page_count;
                endPage.value = data.page_count;
            } else {
                // Handle missing page count
                pageSelect.disabled = true;
                processBtn.disabled = true;
                uploadError.textContent = 'Error: Could not determine page count. The PDF may be invalid or corrupted.';
                uploadError.style.display = 'block';
            }

            processBtn.textContent = 'Process Document';

        } catch (error) {
            console.error('Upload error:', error);
            uploadError.textContent = `Error: ${error.message}`;
            uploadError.style.display = 'block';
            processBtn.textContent = 'Process Document';

            // Show API debug info (helpful for developers)
            apiDebug.style.display = 'block';
            apiDebugContent.textContent = `Error type: ${error.name}\nMessage: ${error.message}\nStack: ${error.stack}`;
        }
    }

    // Handle page selection change
    function handlePageSelectChange() {
        if (pageSelect.value === 'custom') {
            customRange.style.display = 'block';
        } else {
            customRange.style.display = 'none';
        }
    }

    // Reset UI state
    function resetUI() {
        // Stop any existing status checks
        if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
            statusCheckInterval = null;
        }

        // Reset progress display
        jobProgress.style.display = 'none';
        progressBar.style.width = '0%';
        progressPercent.textContent = '0';
        jobStatus.textContent = 'Waiting...';
        jobStatus.className = 'job-status';
        currentPage.textContent = '-';
        currentStep.textContent = '-';

        // Reset error messages
        processError.style.display = 'none';

        // Reset results section
        noResults.style.display = 'block';
        resultContainer.style.display = 'none';
        resultIframe.src = 'about:blank';

        // Hide troubleshooting and debug sections
        troubleshooting.style.display = 'none';
        apiDebug.style.display = 'none';
    }

    // Fetch default processing parameters
    async function fetchDefaultParams() {
        try {
            console.log('Fetching default parameters from:', `${API_BASE_URL}/params`);
            const response = await fetch(`${API_BASE_URL}/params`);

            if (!response.ok) {
                console.error('Failed to load default parameters:', response.status);
                throw new Error('Failed to load default parameters');
            }

            const params = await response.json();
            console.log('Default parameters:', params);

            xFactor.value = params.x_factor;
            yFactor.value = params.y_factor;
            dpi.value = params.dpi;
        } catch (error) {
            console.error('Error loading default parameters:', error);
            // Show troubleshooting if we can't connect to the API
            troubleshooting.style.display = 'block';
        }
    }

    // Process the document
    async function processDocument() {
        if (!currentJobId) return;

        // Get processing parameters
        const params = {
            job_id: currentJobId,
            x_factor: parseFloat(xFactor.value),
            y_factor: parseFloat(yFactor.value),
            dpi: parseInt(dpi.value)
        };

        // Get page selection
        if (pageSelect.value === 'custom') {
            const start = parseInt(startPage.value);
            const end = parseInt(endPage.value);

            if (isNaN(start) || isNaN(end) || start < 1 || end < start || end > currentFileInfo.pageCount) {
                processError.textContent = 'Invalid page range';
                processError.style.display = 'block';
                return;
            }

            params.pages = Array.from({length: end - start + 1}, (_, i) => start + i);
        }

        // Show progress section
        jobProgress.style.display = 'block';
        processBtn.disabled = true;
        processBtn.textContent = 'Processing...';
        processError.style.display = 'none';

        try {
            console.log('Processing job with parameters:', params);
            const response = await fetch(`${API_BASE_URL}/process`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(params)
            });

            console.log('Process response status:', response.status);

            // Get response text first
            const responseText = await response.text();
            console.log('Process response text:', responseText.substring(0, 100));

            let data;
            try {
                data = JSON.parse(responseText);
            } catch (jsonError) {
                console.error('Failed to parse process response as JSON:', jsonError);
                throw new Error(`Server returned invalid JSON: ${responseText.substring(0, 100)}...`);
            }

            if (!response.ok) {
                throw new Error(data.error || `Processing failed with status ${response.status}`);
            }

            // Start checking status periodically
            checkJobStatus();
            statusCheckInterval = setInterval(checkJobStatus, 2000);

        } catch (error) {
            console.error('Processing error:', error);
            processError.textContent = `Error: ${error.message}`;
            processError.style.display = 'block';
            processBtn.disabled = false;
            processBtn.textContent = 'Process Document';
            troubleshooting.style.display = 'block';
        }
    }

    // Check job status
    async function checkJobStatus() {
        if (!currentJobId) return;

        try {
            console.log('Checking job status:', currentJobId);
            const response = await fetch(`${API_BASE_URL}/jobs/${currentJobId}`);

            if (!response.ok) {
                console.error('Job status check failed:', response.status);
                throw new Error('Failed to get job status');
            }

            const data = await response.json();
            console.log('Job status:', data.status, 'Progress:', data.progress);

            // Update progress
            progressPercent.textContent = data.progress;
            progressBar.style.width = `${data.progress}%`;

            // Update status
            jobStatus.textContent = data.status;
            jobStatus.className = `job-status status-${data.status}`;

            // Update current page and step
            currentPage.textContent = data.current_page || '-';
            currentStep.textContent = data.current_step || '-';

            // Check if job is completed
            if (data.status === 'completed') {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;

                processBtn.disabled = false;
                processBtn.textContent = 'Process Document';

                // Show results
                loadResults();
            }

            // Check if job failed
            if (data.status === 'error') {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;

                processBtn.disabled = false;
                processBtn.textContent = 'Process Document';

                if (data.errors && data.errors.length > 0) {
                    processError.textContent = `Error: ${data.errors[0]}`;
                    processError.style.display = 'block';
                }
            }

        } catch (error) {
            console.error('Status check error:', error);
        }
    }

    // Load results
    async function loadResults() {
        if (!currentJobId) return;

        try {
            console.log('Loading results for job:', currentJobId);
            // Show result iframe with the results index page
            noResults.style.display = 'none';
            resultContainer.style.display = 'block';

            const resultsUrl = `${API_BASE_URL}/results/${currentJobId}/view`;
            console.log('Loading results from:', resultsUrl);
            resultIframe.src = resultsUrl;
        } catch (error) {
            console.error('Error loading results:', error);
        }
    }
</script>
</body>
</html>